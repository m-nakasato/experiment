import{Synth as e,CWav as t,NWav as s,Wav as n}from"synth.js";import{Analyser as a}from"analyser.js";import{lfsr as i}from"util.js";const l=document.querySelector.bind(document),r=document.querySelectorAll.bind(document);let o,u,c,_,p=new XMLHttpRequest;p.responseType="arraybuffer",p.withCredentials=!0,p.onload=()=>{b("response"),o.decodeAudioData(p.response,(e=>_=e));let e=new AudioBufferSourceNode(o,{buffer:_});e.connect(o.destination);let t=o.currentTime;e.start(t),e.stop(t+1),e.onended=()=>{e.disconnect(),e.buffer=null}};let v,h={test:"8BEDA8ADFE410279CEDCCB9757413545",Ah:"DFFD8311259BCCBA8754338CED820025",Ee:"ABCCDEEEFFEDCA874474046225644788",Oo:"CDBA999BDFFEC9753443365354102469",Eh:"FFECA8743019804EF869CB758A88BEFF",Oh:"DFFFDA864322123579CFFEDD82001347",sinesaw:"8ACDEEFFFFEEDCA80123456789ABCDEF",dblsaw:"0123456789ABCDEF02468ACE02468ACE",arrow1:"00FF11EE22DD33CC44BB55AA66997788",arrow2:"0000EEEE2222CCCC4444AAAA66668888",epiano:"756424202202545877BCBFFEEFCDEBAB",guitar:"8FDBABB0047B657650358ACA6A531254",bass:"011234556778899ABCDEFDCA86420677",tom1:"00112469BDEEEFFFFEEEEDB964211100",tom2:"BB9999999999AACC0000000000000000",custom:"FFFFFFFFFFFFFFFF0000000000000000"};class F{#e;#t;#s;#n;#a;constructor(e,t){this.#e=e,this.#t=this.#i(t),this.#n=t}#l(e,t){let s=[];return e.forEach((e=>{if(/^[%\*][24]?$/.test(e)){let t=/[24]/.exec(e);t=null===t?1:t[0]-0;for(let e=0;e<t;e++)s.push(s[s.length-t])}else t?s.push(this.#l(e.split("/"))):s.push(e)})),s}#r(e,t){t.forEach((t=>{let[s,n]=t.split(":");e[1][s]=isNaN(n)?n.split("-").map((e=>isNaN(e)?e:Number(e))):n-0}))}#i(e){let t=[],s=60/e.bpm;return e.notes.forEach(((n,a)=>{let i=this.#l(n.split("|"),1),l=[];e.barSeq.forEach((t=>{i[t].forEach((t=>{let n;t.split(" ").forEach((t=>{if("+"==t)return void l.push(n);let i=t.split(","),r=[i[0],{}],o=/\.$/.test(i[1])?1.5:1;if(/t$/.test(i[1])&&(i[1]=i[1].slice(0,-1),i[1]*=1.5),r[1].dur=4*s/i[1]*o,e.set[a].ini&&this.#r(r,e.set[a].ini.split(",")),i.length>2&&/^set/.test(i[2])){let t=i[2].split(":")[1],s=e.set[a][t].split(",");i.pop(),s.forEach((e=>i.push(e)))}i.length>2&&this.#r(r,i.slice(2)),n=r,l.push(r)}))}))})),t.push(l)})),t}#o(e,t,s){let n=0;return t.forEach((t=>{let a=s;e>0&&(a-=e),this.#t[t].forEach((e=>{a<0||"_"==e[0]?a+=e[1].dur:(e[1].sTime=a,a=this.#e[t].play(...e).eTime)})),n<a&&(n=a)})),{sTime:s,eTime:n}}#u(){let e=this.#n.notes.length;return[...Array(e)].map(((e,t)=>t))}play(e=0,t=this.#u(),s=this.#e[0].now,n=0){let a=this.#n,i=60*a.beat/a.bpm*a.intro,l=0==n?e:i,r=this.#o(l,t,s);b(JSON.stringify(r)+"cnt: "+n),a.loop&&(this.#a=setTimeout((()=>{this.play(e,t,r.eTime,n+1)}),1e3*(r.eTime-r.sTime)))}stop(){clearTimeout(this.#a),this.#e.forEach((e=>e.discard()))}}let d={bpm:100,beat:4,loop:1,intro:1,notes:["_,16/E5,16 + _,16 E5,16/_,16 C5,16 E5,16 _,16/G5,16 _,8./G4,16 _,8.|C5,16 _,8 G4,16/_,8 E4,16 _,16/_,16 A4,16 _,16 B4,16/_,16 A#4,16 A4,16 _,16|G4,8t,set:tri E5,8t,set:tri G5,8t,set:tri/A5,16 _,16 F5,16 G5,16/_,16 E5,16 _,16 C5,16/D5,16 B4,16 _,8|_,8 G5,16 F#5,16/F5,16 D#5,16 _,16 E5,16/_,16 G#4,16 A4,16 C5,16/_,16 A4,16 C5,16 D5,16|_,8 G5,16 F#5,16/F5,16 D#5,16 _,16 E5,16/_,16 C6,16 _,16 C6,16/C6,16 _,8.|_,8 G5,16 F#5,16/F5,16 D#5,16 _,16 E5,16/_,16 G#4,16 A4,16 C5,16/_,16 A4,16 C5,16 D5,16|_,8 D#5,16 _,16/_,16 D5,16 _,8/C5,16 _,8./_,4|C5,16 + _,16 C5,16/_,16 C5,16 D5,16 _,16/E5,16 C5,16 _,16 A4,16/G4,16 _,8.|C5,16 + _,16 C5,16/_,16 C5,16 D5,16 E5,16/_,4/*|E5,16 C5,16 _,16 G4,16/_,8 G#4,16 _,16/A4,16 F5,16 _,16 F5,16/A4,16 _,8.|B4,8t,set:tri A5,8t,set:tri +/A5,8t,set:tri G5,8t,set:tri F5,8t,set:tri/E5,16 C5,16 _,16 A4,16/G4,16 _,8.|B4,16 F5,16 _,16 F5,16/F5,8t,set:tri E5,8t,set:tri D5,8t,set:tri/C5,16 _,8./_,4","_,16/F#4,16 + _,16 F#4,16/_,16 F#4,16 + _,16/B4,16 _,8./_,4|E4,16 _,8 C4,16/_,8 G3,16 _,16/_,16 C4,16 _,16 D4,16/_,16 C#4,16 C4,16 _,16|C4,8t,set:tri G4,8t,set:tri B4,8t,set:tri/C5,16 _,16 A4,16 B4,16/_,16 A4,16 _,16 E4,16/F4,16 D4,16 _,8|_,8 E5,16 D#5,16/D5,16 B4,16 _,16 C5,16/_,16 E4,16 F4,16 G4,16/_,16 C4,16 E4,16 F4,16|_,8 E5,16 D#5,16/D5,16 B4,16 _,16 C5,16/_,16 F5,16 _,16 F5,16/F5,16 _,8.|_,8 E5,16 D#5,16/D5,16 B4,16 _,16 C5,16/_,16 E4,16 F4,16 G4,16/_,16 C4,16 E4,16 F4,16|_,8 G#4,16 _,16/_,16 F4,16 _,8/E4,16 _,8./_,4|G#4,16 + _,16 G#4,16/_,16 G#4,16 A#4,16 _,16/G4,16 E4,16 _,16 E4,16/C4,16 _,8.|G#4,16 + _,16 G#4,16/_,16 G#4,16 A#4,16 G4,16/_,4/*|C5,16 A4,16 _,16 E4,16/_,8 E4,16 _,16/F4,16 C5,16 _,16 C5,16/F4,16 _,8.|G4,8t,set:tri F5,8t,set:tri +/F5,8t,set:tri E5,8t,set:tri D5,8t,set:tri/C5,16 A4,16 _,16 F4,16/E4,16 _,8.|G4,16 D5,16 _,16 D5,16/D5,8t,set:tri C5,8t,set:tri B4,8t,set:tri/G4,16 E4,16 _,16 E4,16/C4,16 _,8.","_,16/D3,16 + _,16 D3,16/_,16 D3,16 + _,16/G4,16 _,8./G3,16 _,8.|G3,16 _,8 E3,16/_,8 C3,16 _,16/_,16 F3,16 _,16 G3,16/_,16 F#3,16 F3,16 _,16|E3,8t C4,8t E4,8t/F4,16 _,16 D4,16 E4,16/_,16 C4,16 _,16 A3,16/B3,16 G3,16 _,8|C3,16 _,8 G3,16/_,8 C4,16 _,16/F3,16 _,8 C4,16/C4,16 + F3,16 _,16|C3,16 _,8 E3,16/_,8 G3,16 C4,16/_,16 G5,16 _,16 G5,16/G5,16 _,16 G3,16 _,16|C3,16 _,8 G3,16/_,8 C4,16 _,16/F3,16 _,8 C4,16/C4,16 + F3,16 _,16|C3,16 _,16 G#3,16 _,16/_,16 A#3,16 _,8/C4,16 _,8 G3,16/G3,16 _,16 C3,16 _,16|G#2,16 _,8 D#3,16/_,8 G#3,16 _,16/G3,16 _,8 C3,16/_,8 G2,16 _,16|%|C3,16 _,8 F#3,16/G3,16 _,16 C4,16 _,16/F3,16 _,16 F3,16 _,16/C4,16 + F3,16 _,16|D3,16 _,8 F3,16/G3,16 _,16 B3,16 _,16/G3,16 _,16 G3,16 _,16/C4,16 + G3,16 _,16|G3,16 _,8 G3,16/G3,8t A3,8t B3,8t/C4,16 _,16 G3,16 _,16/C3,16 _,8.","_,16/1,16 _,16 1,16,set:chh 1,16/_,16 1,16,set:chh 1,16 _,16/1,16 _,8 1,16/_,16 1,16,set:chh + +|19,16,set:bd _,16 1,16,set:chh 1,16,set:chh2/1,16 _,16 1,16,set:chh 1,16,set:chh2/*2|%|%2|%2|1,16 _,8 1,16/_,8 1,16 _,16/1,16 _,8 1,16/_,16 1,16,set:chh + +|%|1,16,set:chh _,8 1,16,set:chh/1,16 _,16 1,16,set:chh _,16/*2|%|%"],barSeq:[0,1,2,1,2,3,4,5,6,3,4,5,6,7,8,7,0,1,2,1,2,9,10,9,11,9,10,9,11,7,8,7,0,9,10,9,11],set:[{ini:"env:.01-.15-.75-.05,vol:.85",tri:"env:.01-.151-.0-.0,vol:.85"},{ini:"env:.01-.15-.75-.05,vol:.85",tri:"env:.01-0-1-.03,vol:.85"},{ini:"env:.01-.15-1-.05"},{ini:"env:0-.15-0-.05,vol:.5",chh:"env:.01-.01-0-0,vol:.5",chh2:"env:.01-.01-0-0,vol:.5,swg:1",bd:"env:0-.2-0-.13,vol:.5"}]};function E(e,t){o.currentTime;let s=setInterval((()=>{l("#analyser").innerHTML="",l("#analyser").append(u.getOscillo(e)),l("#analyser").append(" "),l("#analyser").append(u.getSpectrum())}),1/e*1e3*50);setTimeout((()=>clearTimeout(s)),1e3*t-100)}function m(e){r("#keyboard input").forEach((e=>e.remove()));let t=l("#waveform").value;if("noise"==t){let t=e.notes;for(let e=0;e<t.length;e++){let t=document.createElement("input");t.setAttribute("type","button"),t.setAttribute("value",e),l("#keyboard").append(t)}}else if("fcNoise"==t){let t=e.notes;for(let e=0;e<t.length;e++){let t=document.createElement("input");t.setAttribute("type","button"),t.setAttribute("value",e),l("#keyboard").append(t)}}else for(let t=2;t<8;t++)for(let s=0;s<12&&!(7==t&&s>0);s++){let n=e.notes[s],a=n+t,i=document.createElement("input");i.setAttribute("type","button"),i.setAttribute("value",a),"#"==n.slice(-1)&&i.classList.add("short"),l("#keyboard").prepend(i)}r("#keyboard input").forEach((t=>{t.addEventListener("touchstart",(e=>{e.preventDefault()})),t.addEventListener("pointerdown",(t=>{t.preventDefault();let s=t.target.value,n=""==l("#tone").value?void 0:l("#tone").value,a=isNaN(l("#duration").valueAsNumber)?void 0:l("#duration").valueAsNumber,i=isNaN(l("#volume").valueAsNumber)?void 0:l("#volume").valueAsNumber,r=isNaN(l("#detune").valueAsNumber)?void 0:l("#detune").valueAsNumber,o=isNaN(l("#sweep").valueAsNumber)?void 0:l("#sweep").valueAsNumber,u=l("#envA").valueAsNumber,c=l("#envD").valueAsNumber,_=l("#envS").valueAsNumber,p=l("#envR").valueAsNumber,v=isNaN(u)||isNaN(c)||isNaN(_)||isNaN(p)?void 0:[u,c,_,p],h=isNaN(l("#vDepth").valueAsNumber)?void 0:l("#vDepth").valueAsNumber,F=isNaN(l("#vRate").valueAsNumber)?void 0:l("#vRate").valueAsNumber,d=""==l("#vWave").value?void 0:l("#vWave").value,m=isNaN(l("#tDepth").valueAsNumber)?void 0:l("#tDepth").valueAsNumber,C=isNaN(l("#tRate").valueAsNumber)?void 0:l("#tRate").valueAsNumber,A=""==l("#tWave").value?void 0:l("#tWave").value,f=e.play(s,{tone:n,dur:a,vol:i,det:r,swp:o,env:v,vib:[h,F,d],trem:[m,C,A]});t.target.classList.add("on"),E(f.freq,a)})),t.addEventListener("pointerup",(e=>{e.preventDefault(),e.target.classList.remove("on")}))})),"gbWave"==t?(""==l("#cwt table").innerHTML&&function(){let e=l("#cwt table");e.innerHTML="";for(let t=15;t>=0;t--){let s=document.createElement("tr");for(let e=0;e<32;e++){let n=document.createElement("td"),a=document.createElement("input");a.setAttribute("type","radio"),a.setAttribute("name","cwt"+e),a.setAttribute("value",t.toString(16).toUpperCase()),n.append(a),s.append(n)}e.append(s)}r("#cwt input[type=radio]").forEach((e=>{e.onclick=e=>{let t=e.target.name.replace("cwt",""),s=l("#cwt input[type=text]"),n="";for(let a=0;a<s.value.length;a++)n+=a==t?e.target.value:s.value[a];s.value=n,l("#cwt input[type=text]").dispatchEvent(new Event("change"))}})),l("#cwt input[type=text]").dispatchEvent(new Event("change"))}(),l("#cwt").classList.remove("hide")):l("#cwt").classList.add("hide")}function C(a,r){let u,c;switch(a){case"sine":case"square":case"sawtooth":case"triangle":u=n,c=a;break;case"fcPulse":u=t,c=["F0","F000","F0000000"];break;case"fcTriangle":u=t,c=["0123456789ABCDEFFEDCBA9876543210"];break;case"noise":u=s,c={};break;case"fcNoise":let e=[i(),i(6)],r=[...new Set([4,8,16,32,64,96,128,160,202,254,380,508,762,1016,2034,4068].map((e=>Math.round(o.sampleRate/1789772.5*e))))].filter((e=>0!=e));u=s,c={functions:e,pitches:r};break;case"gbWave":let _=l("#cwt input[type=text]").value;h.custom=_,u=t,c=Object.values(h)}let _=new u(o,c);return new e(o,_,r)}function A(){let e=l("#waveform").value;c=C(e,u.node)}function f(){l("#state").onclick=()=>{b(o.state)},l("#resume").onclick=()=>{o.resume()},l("#memChk").onclick=()=>{b(window.crossOriginIsolated)},l("#keyA2").onclick=()=>{p.open("GET","https://m-nakasato.github.io/experiment/Piano.ff.A2.m4a",!0),p.send()},l("#pwr").onclick=()=>{l("#pwr").classList.contains("on")?o.close():(o=new window.AudioContext,u=new a(o),A(),m(c)),l("#pwr").classList.toggle("on")},l("#waveform").onchange=e=>{l("#tone").innerHTML="";let t=[];0==e.target.value.indexOf("fcPulse")?t=["1:1","1:3","1:7"]:"gbWave"==e.target.value?t=Object.keys(h):"fcNoise"==e.target.value&&(t=["long","short"]),t.forEach(((e,t)=>{let s=document.createElement("option");s.innerText=e,s.value=t,l("#tone").append(s)})),A(),m(c)},l("#cwt input[type=text]").onchange=e=>{A(),m(c)},l("#coin").onclick=()=>{let e=""==l("#tone").value?void 0:l("#tone").value,t=c.play("B5",{tone:e,dur:.1});E(c.play("E6",{tone:e,sTime:t.eTime,dur:1,env:[0,0,1,1]}).freq,1.1)},l("#gameover").onclick=()=>{let e=C("fcPulse"),t=C("fcTriangle"),s=.4,n=[["A#4","A#4","A#4","A#4","C#5","C5","C#5","C5","A#4","A#4","A#4","A#4"],["F4","F#4","F4","F#4","F4","F#4","F4","F#4"],["A#3","C#4","A#3","C#4","A#3","C#4","A#3","C#4"]],a=[[s,s/3*2,s/3,s,s/3*2,s/3,.04,s/3*2-.04,s/3,s/3*2,s/3,.8],[s,s,s,s,s,s,s,s],[s,s,s,s,s,s,s,s]],i=[];i[0]=t.play(n[0][0],{dur:a[0][0],vol:1}),i[1]=e.play(n[1][0],{dur:a[1][0],vol:.75}),i[2]=e.play(n[2][0],{dur:a[2][0],vol:.75});for(let e=1;e<n[0].length;e++)i[0]=t.play(n[0][e],{sTime:i[0].eTime,dur:a[0][e],vol:1});for(let t=1;t<n[1].length;t++)i[1]=e.play(n[1][t],{sTime:i[1].eTime,dur:a[1][t],vol:.75}),i[2]=e.play(n[2][t],{sTime:i[2].eTime,dur:a[2][t],vol:.75})},l("#seqPlay").onclick=()=>{!function(){let e=[];r("#ch select").forEach((t=>e.push(C(t.value))));let t=l("#bpm").valueAsNumber;d.bpm=t,v=new F(e,d);let s=l("#skip").value,n=[];r("#ch li input").forEach(((e,t)=>{e.checked&&n.push(t)})),v.play(2.4*s,n)}()},l("#seqStop").onclick=()=>v.stop(),l("#cwt input[type=text]").onchange=e=>{let t=e.target;""==t.value&&(t.value="FFFFFFFFFFFFFFFF0000000000000000");for(let e=0;e<t.value.length;e++)r("input[name=cwt"+e+"]").forEach((s=>{s.checked=t.value[e]==s.value}));A()},l("#cwt input[type=button]").onclick=e=>{let t=l("#tone").value;if("custom"==t)return;let s=h[t];l("#cwt input[type=text]").value=s,l("#cwt input[type=text]").dispatchEvent(new Event("change"))},function(){let e=l("#ch"),t=["fcPulse","fcPulse","fcTriangle","fcNoise"];for(let s=0;s<4;s++){let n=document.createElement("li"),a=document.createElement("input");a.setAttribute("type","checkbox"),a.setAttribute("checked","checked"),n.append(a);let i=l("#waveform").cloneNode(!0);i.removeAttribute("id"),i.value=t[s],n.append(i),e.append(n)}for(let e=0;e<d.barSeq.length;e++){let t=document.createElement("option");t.innerText=e,l("#skip").append(t)}}()}function b(e){l("#debug").innerHTML=l("#debug").innerHTML+"<br/>"+e}window.onload=function(){f()};
